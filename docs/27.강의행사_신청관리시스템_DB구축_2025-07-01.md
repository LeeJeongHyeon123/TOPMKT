# 강의/행사 신청 관리 시스템 DB 구축

**작업일**: 2025-07-01  
**작업자**: Claude  
**작업 유형**: 데이터베이스 설계 및 구축  

## 📋 작업 개요

강의와 행사에 대한 참가 신청을 체계적으로 관리할 수 있는 데이터베이스 시스템을 구축했습니다. 기존 `lecture_registrations` 테이블을 확장하여 완전한 신청 관리 기능을 제공합니다.

## 🗃️ 데이터베이스 구조 변경사항

### 1. `lectures` 테이블 확장

기존 강의 테이블에 참가자 관리 필드 추가:

```sql
ALTER TABLE lectures ADD COLUMN:
- max_participants INT NULL COMMENT '최대 참가자 수 (NULL이면 무제한)'
- current_participants INT DEFAULT 0 COMMENT '현재 참가자 수'  
- auto_approval BOOLEAN DEFAULT FALSE COMMENT '자동 승인 여부'
- registration_start_date DATETIME NULL COMMENT '신청 시작일시'
- registration_end_date DATETIME NULL COMMENT '신청 마감일시'
- allow_waiting_list BOOLEAN DEFAULT FALSE COMMENT '대기자 명단 허용 여부'
```

### 2. `lecture_registrations` 테이블 확장

기존 테이블 구조를 유지하면서 관리 기능 강화:

**기존 필드 (유지)**:
- `participant_name`, `participant_email`, `participant_phone`
- `company_name`, `position`, `special_requests`
- `payment_status`, `payment_amount`, `payment_date`

**새로 추가된 필드**:
```sql
- processed_by INT(11) NULL COMMENT '처리한 관리자/기업 사용자 ID'
- processed_at TIMESTAMP NULL COMMENT '처리 일시'
- admin_notes TEXT NULL COMMENT '관리자 메모/거절 사유'
- attendance_checked_at TIMESTAMP NULL COMMENT '출석 체크 시간'
- attendance_checked_by INT(11) NULL COMMENT '출석 체크한 사용자 ID'
- motivation TEXT NULL COMMENT '참가 동기/목적'
- how_did_you_know VARCHAR(255) NULL COMMENT '어떻게 알게 되었는지'
- is_waiting_list BOOLEAN DEFAULT FALSE COMMENT '대기자 명단 여부'
- waiting_order INT NULL COMMENT '대기 순번'
```

**상태 확장**:
```sql
status ENUM('pending', 'approved', 'rejected', 'cancelled', 'attended', 'no_show', 'waiting')
```

### 3. 새로 생성된 테이블들

#### `registration_history` - 신청 처리 이력
```sql
- registration_id INT(11) NOT NULL
- action_type ENUM('apply', 'approve', 'reject', 'cancel', 'attend', 'no_show', ...)
- old_status VARCHAR(50) NULL
- new_status VARCHAR(50) NULL  
- notes TEXT NULL
- performed_by INT(11) NOT NULL
- performed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
```

#### `notification_settings` - 알림 설정
```sql
- user_id INT(11) NOT NULL
- lecture_id INT(11) NULL (NULL이면 전체 설정)
- email_new_registration BOOLEAN DEFAULT TRUE
- email_registration_approved BOOLEAN DEFAULT TRUE
- email_registration_rejected BOOLEAN DEFAULT TRUE
- email_lecture_reminder BOOLEAN DEFAULT TRUE
- system_new_registration BOOLEAN DEFAULT TRUE
- system_capacity_warning BOOLEAN DEFAULT TRUE
```

### 4. 뷰(Views) 생성

#### `registration_statistics` - 통계 뷰
실시간 신청 현황 및 정원 비율 계산:
```sql
- lecture_id, lecture_title, content_type
- max_participants, current_participants
- total_applications, pending_count, approved_count
- rejected_count, cancelled_count, attended_count
- capacity_percentage (정원 대비 승인 비율)
```

#### `registration_api_view` - API 호환 뷰
기존 테이블 구조와 새 API 설계 간 매핑:
```sql
- participant_name → applicant_name 매핑
- participant_email → applicant_email 매핑
- position → applicant_position 매핑
```

## ⚙️ 자동화 시스템 구축

### 1. 트리거 시스템

#### `update_participant_count_after_registration`
- 신청 상태 변경시 `current_participants` 자동 업데이트
- `registration_history`에 변경 이력 자동 기록

#### `update_participant_count_after_insert`  
- 신규 신청시 이력 기록
- 자동 승인 설정된 강의의 경우 즉시 승인 처리
- 참가자 수 자동 계산

### 2. 인덱스 최적화

성능 향상을 위한 복합 인덱스 추가:
```sql
- idx_processed (processed_by, processed_at)
- idx_waiting_list (lecture_id, is_waiting_list, waiting_order)  
- idx_status_date (status, registration_date)
```

## 🔧 구현된 주요 기능

### 1. 신청 관리 기능
- ✅ **자동/수동 승인 시스템**: `auto_approval` 필드로 제어
- ✅ **정원 관리**: `max_participants`와 `current_participants`로 실시간 관리
- ✅ **대기자 명단**: 정원 초과시 `waiting_order`로 순번 관리
- ✅ **신청 기간 제한**: `registration_start_date`, `registration_end_date`

### 2. 출석 관리 기능
- ✅ **출석 체크**: `attendance_checked_at`, `attendance_checked_by`
- ✅ **노쇼 관리**: `no_show` 상태로 무단 불참 관리
- ✅ **참석 확인**: `attended` 상태로 실제 참석 기록

### 3. 알림 시스템 기반
- ✅ **개별 설정**: 사용자별, 강의별 세분화된 알림 설정
- ✅ **이메일 알림**: 신청/승인/거절/리마인더 등
- ✅ **시스템 알림**: 대시보드 내 실시간 알림

### 4. 데이터 분석 기능
- ✅ **실시간 통계**: `registration_statistics` 뷰로 즉시 조회
- ✅ **이력 추적**: 모든 상태 변경 이력 완전 기록
- ✅ **정원 비율**: 실시간 수용률 계산

## 📊 기존 시스템과의 호환성

### 1. 결제 시스템 완전 호환
- 기존 `payment_status`, `payment_amount`, `payment_date` 필드 그대로 유지
- 결제 완료 후 승인 처리 워크플로우 지원

### 2. 사용자 권한 시스템 연동
- `users.role` (ROLE_USER, ROLE_CORP, ROLE_ADMIN) 활용
- `company_profiles` 테이블과 연동하여 기업 정보 자동 매핑

### 3. 기존 API 구조 보존
- `registration_api_view`를 통해 기존 코드 수정 최소화
- 점진적 마이그레이션 지원

## 🚀 다음 구현 단계

### Phase 1: 기본 기능 (2주)
1. **사용자 신청 폼 UI** - 강의/행사 신청 인터페이스
2. **기본 CRUD API** - 신청, 조회, 수정, 취소
3. **간단한 관리 페이지** - 기업용 신청 목록 조회

### Phase 2: 고급 관리 (2주)  
1. **기업 대시보드** - 신청자 관리 및 승인/거절 처리
2. **통계 및 리포트** - 실시간 현황 및 엑셀 다운로드
3. **출석 체크 시스템** - QR코드 또는 수동 체크

### Phase 3: 알림 및 최적화 (1주)
1. **이메일 알림 시스템** - 자동 알림 발송
2. **성능 최적화** - 페이징, 캐싱, 비동기 처리
3. **모바일 최적화** - 반응형 디자인

## 📝 기술적 고려사항

### 1. 보안
- CSRF 토큰 검증 필수
- 기업 권한 검증 (본인 강의만 관리)
- 개인정보 처리 로그 기록

### 2. 성능
- 대용량 신청자 목록 페이징 처리
- 통계 데이터 캐싱
- 이메일 발송 큐 시스템

### 3. 확장성
- 행사별 맞춤 신청 폼 지원
- 다양한 결제 방식 연동
- 외부 시스템 API 연동

## 📂 관련 파일

- `/workspace/database/add_registration_system.sql` - 초기 설계 SQL
- `/workspace/database/fix_registration_system.sql` - 오류 수정 SQL
- `/workspace/database/update_existing_registrations_table.sql` - 최종 적용 SQL

## ✅ 완료 확인

```sql
-- 테이블 구조 확인
DESCRIBE lecture_registrations;

-- 트리거 확인  
SHOW TRIGGERS LIKE 'lecture_registrations';

-- 뷰 확인
SHOW FULL TABLES WHERE Table_type = 'VIEW';
```

**결과**: 모든 테이블, 트리거, 뷰가 정상적으로 생성되어 신청 관리 시스템의 데이터베이스 인프라가 완벽하게 구축되었습니다.