# 탑마케팅 플랫폼 DB 구조

**최종 수정일:** 2025-12-19 KST  
**상태:** 실제 구현된 테이블 구조 반영 완료

---

커뮤니티 기반 플랫폼의 주요 데이터 모델을 정의합니다. 모든 테이블은 MariaDB InnoDB 스토리지 엔진을 사용하며, 외래 키 제약과 인덱스를 통해 데이터 무결성 및 조회 성능을 보장합니다.

**🎯 현재 구현 상태:** 회원가입/로그인/커뮤니티 게시판/강의 일정 시스템 완전 구동

## ER 다이어그램

```mermaid
erDiagram
    USERS {
        INT id PK "Primary Key"
        VARCHAR phone "Unique"
        VARCHAR nickname "Unique"
        VARCHAR email "Unique"
        VARCHAR password
        BOOLEAN phone_verified
        BOOLEAN email_verified
        ENUM role
        ENUM status
        TIMESTAMP created_at
        TIMESTAMP updated_at
    }
    USER_SESSIONS {
        VARCHAR id PK "Session ID"
        INT user_id FK "→ USERS.id"
        VARCHAR ip_address
        TEXT user_agent
        TIMESTAMP last_activity
        TIMESTAMP created_at
    }
    USER_LOGS {
        INT id PK
        INT user_id FK "→ USERS.id"
        VARCHAR action
        TEXT description
        VARCHAR ip_address
        TEXT user_agent
        JSON extra_data
        TIMESTAMP created_at
    }
    VERIFICATION_CODES {
        INT id PK
        VARCHAR phone
        VARCHAR code
        ENUM type
        INT attempts
        BOOLEAN is_used
        TIMESTAMP expires_at
        TIMESTAMP created_at
    }
    POSTS {
        INT id PK
        INT user_id FK "→ USERS.id"
        INT category_id
        VARCHAR title
        TEXT content
        INT view_count
        INT like_count
        INT comment_count
        BOOLEAN is_pinned
        BOOLEAN is_hidden
        TIMESTAMP created_at
        TIMESTAMP updated_at
    }
    COMMENTS {
        INT id PK
        INT post_id FK "→ POSTS.id"
        INT user_id FK "→ USERS.id"
        INT parent_id FK "→ COMMENTS.id"
        TEXT content
        INT like_count
        BOOLEAN is_hidden
        TIMESTAMP created_at
        TIMESTAMP updated_at
    }
    SETTINGS {
        VARCHAR key_name PK
        TEXT value
        VARCHAR description
        ENUM type
        BOOLEAN is_public
        TIMESTAMP updated_at
    }

    USERS ||--o{ POSTS : "writes"
    USERS ||--o{ COMMENTS : "writes"
    POSTS ||--o{ COMMENTS : "has"
    USERS ||--o{ USER_SESSIONS : "owns"
    USERS ||--o{ USER_LOGS : "logs"
    COMMENTS ||--o{ COMMENTS : "replies"
```

## 📋 실제 구현된 테이블 정의

### 1. users (회원 정보)
- **설명:** 사용자 계정 정보, 인증 상태, 권한 관리를 위한 테이블
- **주요 컬럼:**
  - `id` INT AUTO_INCREMENT PRIMARY KEY
  - `phone` VARCHAR(13) NOT NULL UNIQUE (휴대폰 번호 010-1234-5678 형식)
  - `nickname` VARCHAR(20) NOT NULL UNIQUE (닉네임)
  - `email` VARCHAR(100) NOT NULL UNIQUE (이메일)
  - `password` VARCHAR(255) NOT NULL (암호화된 비밀번호)
  - `phone_verified` BOOLEAN DEFAULT FALSE (휴대폰 인증 여부)
  - `email_verified` BOOLEAN DEFAULT FALSE (이메일 인증 여부)
  - `terms_agreed` BOOLEAN DEFAULT FALSE (이용약관 동의)
  - `privacy_agreed` BOOLEAN DEFAULT FALSE (개인정보처리방침 동의)
  - `marketing_agreed` BOOLEAN DEFAULT FALSE (마케팅 정보 수신 동의)
  - `status` ENUM('ACTIVE', 'INACTIVE', 'SUSPENDED', 'DELETED') DEFAULT 'ACTIVE'
  - `role` ENUM('GENERAL', 'PREMIUM', 'ADMIN', 'SUPER_ADMIN') DEFAULT 'GENERAL'
  - `last_login_at` TIMESTAMP NULL (마지막 로그인 시간)
  - `failed_login_attempts` INT DEFAULT 0 (로그인 실패 횟수)
  - `locked_until` TIMESTAMP NULL (계정 잠금 해제 시간)
  - `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP
  - `updated_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP

### 2. user_sessions (회원 세션 관리)
- **설명:** 사용자 세션 관리 및 보안을 위한 테이블
- **주요 컬럼:**
  - `id` VARCHAR(128) PRIMARY KEY (세션 ID)
  - `user_id` INT NOT NULL (사용자 ID)
  - `ip_address` VARCHAR(45) NOT NULL (IP 주소)
  - `user_agent` TEXT NULL (User Agent)
  - `last_activity` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
  - `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP
- **제약 및 인덱스:**
  - FOREIGN KEY (`user_id`) REFERENCES `users`(`id`) ON DELETE CASCADE
  - INDEX (`user_id`), INDEX (`last_activity`)

### 3. user_logs (사용자 활동 로그)
- **설명:** 사용자 활동 및 시스템 이벤트 기록을 위한 테이블
- **주요 컬럼:**
  - `id` INT AUTO_INCREMENT PRIMARY KEY
  - `user_id` INT NULL (사용자 ID, 비회원 활동도 기록)
  - `action` VARCHAR(50) NOT NULL (활동 유형: LOGIN, LOGOUT, SIGNUP 등)
  - `description` TEXT NULL (상세 설명)
  - `ip_address` VARCHAR(45) NOT NULL (IP 주소)
  - `user_agent` TEXT NULL (User Agent)
  - `extra_data` JSON NULL (추가 데이터)
  - `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP
- **제약 및 인덱스:**
  - FOREIGN KEY (`user_id`) REFERENCES `users`(`id`) ON DELETE SET NULL
  - INDEX (`user_id`), INDEX (`action`), INDEX (`created_at`)

### 4. verification_codes (인증번호 임시 저장)
- **설명:** SMS 인증번호 임시 저장 및 관리를 위한 테이블
- **주요 컬럼:**
  - `id` INT AUTO_INCREMENT PRIMARY KEY
  - `phone` VARCHAR(13) NOT NULL (휴대폰 번호)
  - `code` VARCHAR(6) NOT NULL (인증번호)
  - `type` ENUM('SIGNUP', 'LOGIN', 'PASSWORD_RESET') NOT NULL (인증 유형)
  - `attempts` INT DEFAULT 0 (시도 횟수)
  - `is_used` BOOLEAN DEFAULT FALSE (사용 여부)
  - `expires_at` TIMESTAMP NOT NULL (만료 시간)
  - `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP
- **제약 및 인덱스:**
  - INDEX (`phone`), INDEX (`code`), INDEX (`expires_at`)

### 5. posts (커뮤니티 게시글)
- **설명:** 커뮤니티 게시글 정보 및 통계를 관리하는 테이블
- **주요 컬럼:**
  - `id` INT AUTO_INCREMENT PRIMARY KEY
  - `user_id` INT NOT NULL (작성자 ID)
  - `category_id` INT NULL (카테고리 ID, 향후 확장용)
  - `title` VARCHAR(200) NOT NULL (제목)
  - `content` TEXT NOT NULL (내용)
  - `view_count` INT DEFAULT 0 (조회수)
  - `like_count` INT DEFAULT 0 (좋아요 수)
  - `comment_count` INT DEFAULT 0 (댓글 수)
  - `is_pinned` BOOLEAN DEFAULT FALSE (공지 고정 여부)
  - `is_hidden` BOOLEAN DEFAULT FALSE (숨김 여부)
  - `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP
  - `updated_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
- **제약 및 인덱스:**
  - FOREIGN KEY (`user_id`) REFERENCES `users`(`id`) ON DELETE CASCADE
  - INDEX (`user_id`), INDEX (`category_id`), INDEX (`created_at`)

### 6. comments (댓글)
- **설명:** 댓글 및 대댓글 정보 관리 테이블
- **주요 컬럼:**
  - `id` INT AUTO_INCREMENT PRIMARY KEY
  - `post_id` INT NOT NULL (게시글 ID)
  - `user_id` INT NOT NULL (작성자 ID)
  - `parent_id` INT NULL (부모 댓글 ID, 대댓글용)
  - `content` TEXT NOT NULL (댓글 내용)
  - `like_count` INT DEFAULT 0 (좋아요 수)
  - `is_hidden` BOOLEAN DEFAULT FALSE (숨김 여부)
  - `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP
  - `updated_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
- **제약 및 인덱스:**
  - FOREIGN KEY (`post_id`) REFERENCES `posts`(`id`) ON DELETE CASCADE
  - FOREIGN KEY (`user_id`) REFERENCES `users`(`id`) ON DELETE CASCADE
  - FOREIGN KEY (`parent_id`) REFERENCES `comments`(`id`) ON DELETE CASCADE
  - INDEX (`post_id`), INDEX (`user_id`), INDEX (`parent_id`)

### 7. lectures (강의 정보)
- **설명:** 강의 일정 및 상세 정보 관리 테이블
- **주요 컬럼:**
  - `id` INT AUTO_INCREMENT PRIMARY KEY
  - `user_id` INT NOT NULL (강의 등록자 ID)
  - `title` VARCHAR(200) NOT NULL (강의 제목)
  - `description` TEXT NOT NULL (강의 설명)
  - `instructor_name` VARCHAR(100) NOT NULL (강사명)
  - `instructor_info` TEXT NULL (강사 정보)
  - `start_date` DATE NOT NULL (시작일)
  - `end_date` DATE NOT NULL (종료일)
  - `start_time` TIME NOT NULL (시작 시간)
  - `end_time` TIME NOT NULL (종료 시간)
  - `timezone` VARCHAR(50) DEFAULT 'Asia/Seoul' (시간대)
  - `location_type` ENUM('online','offline') DEFAULT 'offline' (강의 형태)
  - `venue_name` VARCHAR(200) NULL (장소명)
  - `venue_address` TEXT NULL (장소 주소)
  - `online_link` VARCHAR(500) NULL (온라인 링크)
  - `max_participants` INT NULL (최대 참가자 수)
  - `registration_fee` INT DEFAULT 0 (등록비)
  - `registration_deadline` DATETIME NULL (등록 마감일)
  - `category` ENUM('seminar','workshop','conference','webinar','training') DEFAULT 'seminar'
  - `difficulty_level` ENUM('beginner','intermediate','advanced','all') DEFAULT 'all'
  - `tags` LONGTEXT NULL (태그, JSON 형태)
  - `banner_image` VARCHAR(500) NULL (배너 이미지)
  - `attachments` LONGTEXT NULL (첨부파일, JSON 형태)
  - `requirements` TEXT NULL (참가 요구사항)
  - `benefits` TEXT NULL (참가 혜택)
  - `status` ENUM('draft','published','cancelled','completed') DEFAULT 'draft'
  - `is_featured` TINYINT(1) DEFAULT 0 (추천 강의 여부)
  - `view_count` INT DEFAULT 0 (조회수)
  - `registration_count` INT DEFAULT 0 (등록자 수)
  - `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP
  - `updated_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
- **제약 및 인덱스:**
  - FOREIGN KEY (`user_id`) REFERENCES `users`(`id`) ON DELETE CASCADE
  - INDEX (`user_id`), INDEX (`start_date`), INDEX (`category`), INDEX (`status`), INDEX (`is_featured`)

### 8. lecture_categories (강의 카테고리)
- **설명:** 강의 분류 관리 테이블
- **주요 컬럼:**
  - `id` INT AUTO_INCREMENT PRIMARY KEY
  - `name` VARCHAR(100) NOT NULL (카테고리명)
  - `description` TEXT NULL (설명)
  - `parent_id` INT NULL (상위 카테고리 ID)
  - `sort_order` INT DEFAULT 0 (정렬 순서)
  - `is_active` TINYINT(1) DEFAULT 1 (활성화 여부)
  - `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP
  - `updated_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
- **제약 및 인덱스:**
  - FOREIGN KEY (`parent_id`) REFERENCES `lecture_categories`(`id`) ON DELETE SET NULL
  - INDEX (`parent_id`), INDEX (`sort_order`)

### 9. lecture_registrations (강의 등록)
- **설명:** 사용자의 강의 등록 정보 관리 테이블
- **주요 컬럼:**
  - `id` INT AUTO_INCREMENT PRIMARY KEY
  - `lecture_id` INT NOT NULL (강의 ID)
  - `user_id` INT NOT NULL (사용자 ID)
  - `registration_date` TIMESTAMP DEFAULT CURRENT_TIMESTAMP (등록일)
  - `status` ENUM('registered','cancelled','completed') DEFAULT 'registered'
  - `payment_status` ENUM('pending','paid','refunded') DEFAULT 'pending'
  - `payment_amount` INT DEFAULT 0 (결제 금액)
  - `notes` TEXT NULL (특이사항)
  - `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP
  - `updated_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
- **제약 및 인덱스:**
  - FOREIGN KEY (`lecture_id`) REFERENCES `lectures`(`id`) ON DELETE CASCADE
  - FOREIGN KEY (`user_id`) REFERENCES `users`(`id`) ON DELETE CASCADE
  - UNIQUE KEY (`lecture_id`, `user_id`) (중복 등록 방지)
  - INDEX (`lecture_id`), INDEX (`user_id`), INDEX (`status`)

### 10. settings (시스템 설정)
- **설명:** 시스템 전역 설정 관리를 위한 테이블
- **주요 컬럼:**
  - `key_name` VARCHAR(100) PRIMARY KEY (설정 키)
  - `value` TEXT NULL (설정 값)
  - `description` VARCHAR(255) NULL (설정 설명)
  - `type` ENUM('STRING', 'INTEGER', 'BOOLEAN', 'JSON') DEFAULT 'STRING' (값 타입)
  - `is_public` BOOLEAN DEFAULT FALSE (공개 설정 여부)
  - `updated_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP

---

## 🔮 향후 확장 계획 (미구현 테이블)

### 1. company_profiles (기업회원 정보)
- **설명:** 기업회원 세부 정보 관리 테이블 (2차 개발 예정)
- **예정 컬럼:**
  - `company_id` INT PRIMARY KEY
  - `user_id` INT NOT NULL (users.id 참조)
  - `company_name` VARCHAR(255) NOT NULL
  - `business_registration` VARCHAR(100) NOT NULL
  - `approved_at` TIMESTAMP NULL
  - `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP

### 2. tags (태그 시스템)
- **설명:** 게시글 태그 관리 테이블 (향후 구현 예정)
- **예정 컬럼:**
  - `tag_id` INT AUTO_INCREMENT PRIMARY KEY
  - `name` VARCHAR(50) NOT NULL UNIQUE

### 3. post_tags (게시글-태그 매핑)
- **설명:** 게시글과 태그의 다대다 관계 테이블
- **예정 컬럼:**
  - `post_id` INT NOT NULL
  - `tag_id` INT NOT NULL
  - PRIMARY KEY (`post_id`, `tag_id`)

### 4. notifications (알림 시스템)
- **설명:** 실시간 알림 정보 저장 테이블 (향후 구현 예정)
- **예정 컬럼:**
  - `notification_id` INT AUTO_INCREMENT PRIMARY KEY
  - `user_id` INT NOT NULL
  - `type` VARCHAR(50) NOT NULL
  - `reference_id` INT NULL
  - `message` VARCHAR(255) NOT NULL
  - `is_read` BOOLEAN DEFAULT FALSE
  - `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP

---

## 📊 관계 및 인덱스 전략

### 외래 키 제약 설정
- **사용자 관련:** `user_sessions.user_id`, `user_logs.user_id`, `posts.user_id`, `comments.user_id`
- **게시글 관련:** `comments.post_id`, `comments.parent_id` (대댓글)
- **CASCADE 정책:** 사용자 삭제 시 관련 데이터 자동 삭제 (user_sessions, posts, comments)
- **SET NULL 정책:** 로그 데이터는 사용자 삭제 후에도 유지 (user_logs.user_id)

### 성능 최적화 인덱스
- **사용자 테이블:** `phone`, `email`, `nickname`, `status`, `created_at`
- **세션 테이블:** `user_id`, `last_activity`
- **로그 테이블:** `user_id`, `action`, `created_at`
- **인증번호 테이블:** `phone`, `code`, `expires_at`
- **게시글 테이블:** `user_id`, `category_id`, `created_at`
- **댓글 테이블:** `post_id`, `user_id`, `parent_id`

### 데이터베이스 설정
- **엔진:** InnoDB (트랜잭션, 외래키 지원)
- **문자셋:** UTF8mb4 (이모지 지원)
- **콜레이션:** utf8mb4_unicode_ci (한글 정렬 지원)

### 확장성 고려사항
- **파티셔닝:** `user_logs` 테이블 월별 파티셔닝 검토 (대용량 로그 데이터)
- **읽기 전용 복제본:** 조회 성능 향상을 위한 Master-Slave 구성 검토
- **캐싱:** Redis를 활용한 세션 및 자주 조회되는 데이터 캐싱

---

## 📝 실제 구현된 DDL 예시

```sql
-- 회원 테이블 (핵심 테이블)
CREATE TABLE users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    phone VARCHAR(13) NOT NULL UNIQUE COMMENT '휴대폰 번호 (010-1234-5678)',
    nickname VARCHAR(20) NOT NULL UNIQUE COMMENT '닉네임',
    email VARCHAR(100) NOT NULL UNIQUE COMMENT '이메일',
    password VARCHAR(255) NOT NULL COMMENT '암호화된 비밀번호',
    phone_verified BOOLEAN DEFAULT FALSE COMMENT '휴대폰 인증 여부',
    email_verified BOOLEAN DEFAULT FALSE COMMENT '이메일 인증 여부',
    terms_agreed BOOLEAN DEFAULT FALSE COMMENT '이용약관 동의',
    privacy_agreed BOOLEAN DEFAULT FALSE COMMENT '개인정보처리방침 동의',
    marketing_agreed BOOLEAN DEFAULT FALSE COMMENT '마케팅 정보 수신 동의',
    status ENUM('ACTIVE', 'INACTIVE', 'SUSPENDED', 'DELETED') DEFAULT 'ACTIVE',
    role ENUM('GENERAL', 'PREMIUM', 'ADMIN', 'SUPER_ADMIN') DEFAULT 'GENERAL',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 커뮤니티 게시글 테이블
CREATE TABLE posts (
    id INT AUTO_INCREMENT PRIMARY KEY,
    user_id INT NOT NULL,
    title VARCHAR(200) NOT NULL,
    content TEXT NOT NULL,
    view_count INT DEFAULT 0,
    like_count INT DEFAULT 0,
    comment_count INT DEFAULT 0,
    is_pinned BOOLEAN DEFAULT FALSE,
    is_hidden BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 댓글 테이블  
CREATE TABLE comments (
    id INT AUTO_INCREMENT PRIMARY KEY,
    post_id INT NOT NULL,
    user_id INT NOT NULL,
    parent_id INT NULL,
    content TEXT NOT NULL,
    like_count INT DEFAULT 0,
    is_hidden BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (post_id) REFERENCES posts(id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (parent_id) REFERENCES comments(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

---

## 🎯 현재 구현 상태 요약

### ✅ 완전 구현된 기능
- **사용자 관리:** 회원가입, 로그인, 세션 관리
- **보안 인증:** SMS 인증, reCAPTCHA v3, 이메일 인증
- **커뮤니티:** 게시글 CRUD, 페이지네이션, 검색
- **로깅:** 사용자 활동 추적, 보안 이벤트 기록

### 🔄 다음 구현 예정
- **댓글 시스템:** 대댓글, 수정/삭제, 실시간 업데이트
- **좋아요 기능:** 게시글/댓글 추천 시스템
- **알림 시스템:** 실시간 알림, FCM 연동
- **태그 시스템:** 게시글 분류 및 검색 최적화
